<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ëº™ËÉéËã±ÈõÑ</title>
    <style>
        :root { height: -webkit-fill-available; }
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: none; user-select: none; height: 100vh; height: -webkit-fill-available; }
        canvas { display: block; width: 100%; height: 100%; }
        #ui { 
            position: absolute; top: 0; left: 0; width: 100%; 
            display: flex; justify-content: space-around; align-items: center; 
            padding: 10px 0; background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px); color: #000; font-weight: 900; 
            font-size: 16px; text-shadow: 1px 1px 0 #fff; z-index: 100; pointer-events: none; 
        }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        #power-ui { position: absolute; top: 50px; right: 20px; color: #ff0000; font-weight: 900; font-size: 24px; text-shadow: 1px 1px 5px #fff; z-index: 100; display: none; }
        #controls { position: absolute; bottom: 25px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 35px; box-sizing: border-box; z-index: 150; align-items: flex-end; }
        .side-right { display: flex; gap: 20px; align-items: flex-end; }
        .action-btn { width: 45px; height: 45px; background: rgba(0,0,0,0.7); border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #fff; backdrop-filter: blur(5px); -webkit-tap-highlight-color: transparent; }
        #leftBtn { width: 85px; height: 85px; font-size: 38px; }
        #fireBtn { background: rgba(211, 47, 47, 0.4); border-color: #ff8a80; opacity: 0.5; }
        #fireBtn.active { background: rgba(211, 47, 47, 0.9); opacity: 1; box-shadow: 0 0 10px #ff0000; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 200; }
        #msg-box { background: #fff; padding: 30px; border: 4px solid #000; border-radius: 20px; text-align: center; width: 280px; }
        .btn { display: inline-block; padding: 18px 45px; background: #FFD600; color: #000; border-radius: 50px; font-weight: bold; font-size: 24px; cursor: pointer; border: none; box-shadow: 0 6px 0 #A68B00; }
    </style>
</head>
<body>

<div id="ui">
    <div class="stat-item">LV: <span id="levelText">1</span></div>
    <div class="stat-item">LIFE: <span id="livesText">üë§üë§üë§</span></div>
    <div class="stat-item">HP: <span id="hpText" style="color: #e91e63;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    <div class="stat-item">SCORE: <span id="score">0</span> / 2500</div>
</div>
<div id="power-ui"><span id="timer">20</span>s üî•</div>

<div id="controls">
    <div class="side-left"><div class="action-btn" id="leftBtn">‚ñ∂</div></div>
    <div class="side-right">
        <div class="action-btn" id="fireBtn">üî•</div> 
        <div class="action-btn" id="jumpBtn">‚ñ≤</div> 
    </div>
</div>

<div id="overlay">
    <div id="msg-box">
        <h2 id="endStatus" style="display:none; margin-top:0;">GAME OVER</h2>
        <button class="btn" id="startBtn">START</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const hpEl = document.getElementById('hpText');
const livesEl = document.getElementById('livesText');
const levelEl = document.getElementById('levelText');
const powerUi = document.getElementById('power-ui');
const timerEl = document.getElementById('timer');
const overlay = document.getElementById('overlay');
const startBtn = document.getElementById('startBtn');
const fireBtn = document.getElementById('fireBtn');
const endStatus = document.getElementById('endStatus');

let gameState = 'START'; 
let score = 0, hp = 5, lives = 3, level = 1, speedOffset = 0, invincibleFrame = 0;
let currentSpeed = 0;
const MAX_SPEED_BASE = 6.2, ACCEL = 0.16, FRICTION = 0.05, GRAVITY = 0.52, JUMP_FORCE = -14.2, ROAD_Y_RATIO = 0.85;

let player = { x: 200, y: 0, vy: 0, jumped: false, powerTime: 0 };
let obstacles = [], coins = [], bullets = [];
let bgX = 0, distanceCounter = 0, isPressingGo = false;

// Èü≥Ê®ÇÊóãÂæã
let audioCtx = null, musicTimer = null, melodyStep = 0;
const MELODIES = [[262, 330, 392, 523, 392, 330, 262, 0], [293, 349, 440, 587, 440, 349, 293, 0], [329, 392, 493, 659, 329, 392, 493, 0], [262, 392, 262, 440, 262, 349, 262, 330]];
const WAVEFORMS = ['triangle', 'square', 'sine', 'sawtooth'];

function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playSound(freq, dur, vol, type = 'sine') {
    if(!audioCtx || freq <= 0) return;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.connect(g).connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}

function loopBGM() {
    if (gameState !== 'PLAYING') return;
    let mIdx = (level - 1) % MELODIES.length;
    let freq = MELODIES[mIdx][melodyStep % 8];
    playSound(freq, 0.25, 0.06, WAVEFORMS[mIdx]); 
    melodyStep++;
    musicTimer = setTimeout(loopBGM, Math.max(140, 320 - (currentSpeed * 20)));
}

function updateUI() {
    hpEl.innerText = "‚ù§Ô∏è".repeat(hp);
    livesEl.innerText = "üë§".repeat(lives);
    levelEl.innerText = level;
    scoreEl.innerText = score;
}

startBtn.onclick = () => {
    initAudio(); 
    score = 0; hp = 5; lives = 3; level = 1; speedOffset = 0;
    obstacles = []; coins = []; bullets = []; player.powerTime = 0;
    currentSpeed = 0; melodyStep = 0;
    gameState = 'PLAYING';
    overlay.style.display = 'none';
    updateUI();
    clearTimeout(musicTimer);
    resize(); loopBGM();
};

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    player.y = canvas.height * ROAD_Y_RATIO - 50;
}
window.addEventListener('resize', resize);

function update() {
    if (gameState !== 'PLAYING') return;
    const maxS = MAX_SPEED_BASE + speedOffset;
    currentSpeed = isPressingGo ? Math.min(maxS, currentSpeed + ACCEL) : Math.max(0, currentSpeed - FRICTION);
    bgX = (bgX - currentSpeed) % canvas.width;
    distanceCounter += currentSpeed;
    
    player.vy += GRAVITY; player.y += player.vy;
    let groundY = canvas.height * ROAD_Y_RATIO - 50;
    if (player.y > groundY) { player.y = groundY; player.vy = 0; player.jumped = false; }
    
    if (player.powerTime > 0) {
        player.powerTime -= 0.016;
        powerUi.style.display = 'block';
        timerEl.innerText = Math.ceil(player.powerTime);
        fireBtn.classList.add('active');
        if (player.powerTime <= 0) { powerUi.style.display = 'none'; fireBtn.classList.remove('active'); }
    }
    if (invincibleFrame > 0) invincibleFrame--;

    if (score >= 2500) { score = 0; level++; lives++; speedOffset += 0.3; updateUI(); playSound(1200, 0.4, 0.1, 'sine'); }

    // ÁîüÊàêÁâ©‰ª∂ÔºöÂ¢ûÂä†ÈáëÂπ£ÈáèÔºåÂÑ™ÂåñÁîüÊàêÈÇèËºØ
    if (distanceCounter > (400 - speedOffset * 10)) { 
        // ÊâπÊ¨°ÁîüÊàê 3 ÂÄçÈáëÂπ£ (ÂéüÊú¨ 1 ÂÄãÔºåÁèæÂú®ÁîüÊàê‰∏ÄÁµÑ)
        for(let i=0; i<3; i++) {
            let type = 'gold';
            let r = Math.random();
            if (i === 0 && r < 0.05) type = 'heart';
            else if (i === 1 && r < 0.15) type = 'red';
            coins.push({ x: canvas.width + 100 + (i*40), y: canvas.height * ROAD_Y_RATIO - 140, type: type });
        }
        
        const isCar = Math.random() > 0.4;
        obstacles.push({ x: canvas.width + 300, y: canvas.height * ROAD_Y_RATIO - 60, type: isCar ? 'car' : 'banana', speed: currentSpeed + (isCar ? 2 : 0) });
        distanceCounter = 0;
    }

    // Á¢∞ÊíûÂÅµÊ∏¨ (ÈáëÂπ£ËàáÈöúÁ§ôÁâ©ÂàÜÈñãËôïÁêÜ‰ª•ÂÑ™ÂåñÊïàËÉΩ)
    for (let i = coins.length - 1; i >= 0; i--) {
        let c = coins[i];
        c.x -= currentSpeed;
        if (Math.abs(player.x - c.x) < 40 && Math.abs(player.y - c.y) < 40) {
            if (c.type === 'heart') hp = 5;
            else if (c.type === 'red') player.powerTime = 20;
            else score += 10;
            coins.splice(i, 1);
            updateUI();
        } else if (c.x < -50) coins.splice(i, 1);
    }

    for (let i = obstacles.length - 1; i >= 0; i--) {
        let o = obstacles[i];
        o.x -= o.speed;
        if (invincibleFrame === 0 && Math.abs(player.x - o.x) < 42 && Math.abs(player.y - o.y) < 42) {
            hp--; invincibleFrame = 90;
            if (hp <= 0) { lives--; hp = 5; if (lives <= 0) { gameState = 'OVER'; endStatus.style.display = 'block'; overlay.style.display = 'flex'; } }
            updateUI();
        } else if (o.x < -100) obstacles.splice(i, 1);
    }

    bullets.forEach((b, bi) => {
        b.x += 12;
        obstacles.forEach((o, oi) => {
            if (Math.abs(b.x - o.x) < 50 && Math.abs(b.y - o.y) < 50) {
                obstacles.splice(oi, 1); bullets.splice(bi, 1);
                score += 50; updateUI();
            }
        });
    });
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // ËÉåÊôØ
    ctx.fillStyle = '#87CEEB'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#2E7D32';
    let mountainX = (bgX * 0.4) % canvas.width;
    for(let i=0; i<2; i++) {
        let x = mountainX + i * canvas.width;
        ctx.beginPath(); ctx.moveTo(x, canvas.height * ROAD_Y_RATIO); ctx.lineTo(x + canvas.width/2, canvas.height * 0.3); ctx.lineTo(x + canvas.width, canvas.height * ROAD_Y_RATIO); ctx.fill();
    }
    // ÈÅìË∑Ø
    ctx.fillStyle = '#444'; ctx.fillRect(0, canvas.height * ROAD_Y_RATIO, canvas.width, canvas.height);
    
    // Áé©ÂÆ∂ (ÈóúÈñâÈô∞ÂΩ±ÂÑ™ÂåñÊïàËÉΩ)
    if (invincibleFrame % 10 < 5) {
        ctx.font = '50px Arial';
        ctx.save();
        ctx.translate(player.x + 25, player.y + 25);
        if (player.powerTime > 0) { // ÂÉÖÂú®Âº∑ÂäõÁãÄÊÖã‰ΩøÁî®Á∞°ÂñÆÁôºÂÖâ
            ctx.strokeStyle = 'red'; ctx.lineWidth = 2; ctx.strokeRect(-25, -25, 50, 50);
        }
        ctx.scale(-1, 1); ctx.fillText('üö¥', 0, 0);
        ctx.restore();
    }
    
    // ÈöúÁ§ôÁâ©ËàáÈáëÂπ£ (Áõ¥Êé•Áπ™Ë£ΩÔºå‰∏ç‰ΩøÁî® shadowBlur)
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    bullets.forEach(b => { ctx.font = '30px Arial'; ctx.fillText('üî•', b.x, b.y); });
    
    obstacles.forEach(o => {
        if(o.type === 'car') {
            ctx.fillStyle = '#D32F2F'; ctx.fillRect(o.x, o.y + 10, 80, 40);
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(o.x+20, o.y+50, 8, 0, 7); ctx.fill(); ctx.beginPath(); ctx.arc(o.x+60, o.y+50, 8, 0, 7); ctx.fill();
        } else { ctx.font = '40px Arial'; ctx.fillText('üçå', o.x + 40, o.y + 30); }
    });

    coins.forEach(c => { 
        if(c.type === 'heart') { ctx.font = '40px Arial'; ctx.fillText('üíñ', c.x, c.y); }
        else if(c.type === 'red') { ctx.font = '40px Arial'; ctx.fillText('üî¥', c.x, c.y); }
        else { ctx.font = '30px Arial'; ctx.fillText('ü™ô', c.x, c.y); }
    });

    update(); requestAnimationFrame(draw);
}

// ÊéßÂà∂Âô®
document.getElementById('leftBtn').ontouchstart = (e) => { e.preventDefault(); isPressingGo = true; };
document.getElementById('leftBtn').ontouchend = () => { isPressingGo = false; };
document.getElementById('jumpBtn').ontouchstart = (e) => { 
    e.preventDefault(); if (!player.jumped && gameState === 'PLAYING') { player.vy = JUMP_FORCE; player.jumped = true; playSound(880, 0.1, 0.05); }
};
document.getElementById('fireBtn').ontouchstart = (e) => { 
    e.preventDefault(); if (player.powerTime > 0 && gameState === 'PLAYING') bullets.push({ x: player.x + 50, y: player.y + 20 });
};

resize();
draw();
</script>
</body>
</html>